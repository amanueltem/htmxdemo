# STAGE 1: Build using GraalVM 25
FROM ghcr.io/graalvm/native-image-community:25 AS builder
WORKDIR /build

COPY .mvn/ .mvn
COPY mvnw pom.xml ./
# Fix line endings just in case
RUN tr -d '\r' < mvnw > mvnw_unix && mv mvnw_unix mvnw && chmod +x mvnw

RUN ./mvnw dependency:go-offline

# Dummy vars for AOT analysis
ENV HTMX_DB_URL=jdbc:postgresql://localhost:5432/dummy
ENV HTMX_DB_USERNAME=dummy
ENV HTMX_DB_PASSWORD=dummy

COPY src ./src
# Using the memory-saving flags we discussed
RUN ./mvnw -Pnative native:compile -DskipTests -Dmaven.test.skip=true

# STAGE 2: Tiny Runtime
FROM gcr.io/distroless/base-debian12
WORKDIR /app
# Use the exact artifact name from your pom.xml
COPY --from=builder /build/target/htmxdemo /app/server
EXPOSE 8080
ENTRYPOINT ["/app/server"]