<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deposit Management</title>
    <link rel="stylesheet" th:href="@{/css/expense.css}">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
<div id="main-content-wrapper" th:fragment="deposit-table-container">

    <div class="header-section">
        <h2>Deposit Dashboard</h2>
        <button sec:authorize="hasRole('INPUTTER')"
                class="btn btn-primary"
                hx-get="/deposits/new"
                hx-target="#modals-here">
            + New Deposit
        </button>
    </div>

    <div id="deposit-table-container" class="table-container">
        <table>
            <thead>
            <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Inputter</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="deposit : ${deposits.content}">
                <td th:text="${deposit.date}"></td>
                <td th:text="${#numbers.formatDecimal(deposit.amount, 1, 2)}"></td>
                <td>
                    <span class="badge"
                          th:classappend="${deposit.entityStatus == 'AUTHORIZED' ? 'bg-success' : 'bg-warning'}"
                          th:text="${deposit.entityStatus}">
                    </span>
                </td>
                <td th:text="${deposit.inputter}"></td>
                <td>
                    <div class="action-group">
                        <button th:if="${deposit.entityStatus == 'UNAUTHORIZED'}"
                                sec:authorize="hasRole('INPUTTER')"
                                class="btn btn-sm btn-outline"
                                th:hx-get="@{/deposits/edit/{id}(id=${deposit.id})}"
                                hx-target="#modals-here">
                            Edit
                        </button>

                        <button th:if="${deposit.entityStatus == 'UNAUTHORIZED'}"
                                sec:authorize="hasRole('INPUTTER')"
                                class="btn btn-sm btn-danger"
                                th:hx-delete="@{/deposits/{id}(id=${deposit.id})}"
                                hx-target="#main-content-wrapper"
                                hx-swap="outerHTML"
                                hx-confirm="Delete this deposit record?">
                            Delete
                        </button>

                        <button th:if="${deposit.entityStatus == 'UNAUTHORIZED' and (currentUser != null and deposit.inputter != currentUser.email)}"
                                sec:authorize="hasRole('AUTHORIZER')"
                                class="btn btn-sm btn-success"
                                th:hx-post="@{/deposits/{id}/authorize(id=${deposit.id})}"
                                hx-target="#main-content-wrapper"
                                hx-swap="outerHTML"
                                hx-confirm="Authorize this deposit?">
                            Authorize
                        </button>
                    </div>
                </td>
            </tr>

            <tr th:if="${deposits == null or deposits.totalElements == 0}">
                <td colspan="5" style="text-align: center; padding: 2rem; color: #64748b;">
                    No deposit records found.
                </td>
            </tr>
            </tbody>
        </table>

        <div class="pagination-bar" th:if="${deposits != null and deposits.totalPages > 1}">
            <button th:if="${deposits.hasPrevious()}"
                    class="btn btn-sm btn-outline"
                    th:hx-get="@{/deposits(page=${deposits.number - 1})}"
                    hx-target="#main-content-wrapper"
                    hx-swap="outerHTML">Previous</button>

            <span class="page-info" th:text="'Page ' + (${deposits.number} + 1) + ' of ' + ${deposits.totalPages}"></span>

            <button th:if="${deposits.hasNext()}"
                    class="btn btn-sm btn-outline"
                    th:hx-get="@{/deposits(page=${deposits.number + 1})}"
                    hx-target="#main-content-wrapper"
                    hx-swap="outerHTML">Next</button>
        </div>
    </div>

    <div id="modals-here"></div>
</div>

</body>
</html>