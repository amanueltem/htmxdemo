<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Manager</title>
    <link rel="stylesheet" th:href="@{/css/expense.css}">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>

<div class="header-section">
    <h2>Expense Dashboard</h2>
    <button sec:authorize="hasRole('ROLE_INPUTTER')"
            class="btn btn-primary"
            hx-get="/expenses/new"
            hx-target="#modals-here">
        + New Record
    </button>
</div>

<div id="expense-table-container" th:fragment="expense-table-container" class="table-container">
    <table>
        <thead>
        <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Inputter</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="expense : ${expenses}">
            <td th:text="${expense.date}"></td>
            <td th:text="${expense.amount}"></td>
            <td>
                        <span class="badge"
                              th:classappend="${expense.entityStatus == 'AUTHORIZED' ? 'bg-success' : 'bg-warning'}"
                              th:text="${expense.entityStatus}">
                        </span>
            </td>
            <td th:text="${expense.inputter}"></td>
            <td>
                <div class="action-group">
                    <button th:if="${expense.entityStatus != 'AUTHORIZED'}"
                            sec:authorize="hasRole('ROLE_INPUTTER')"
                            class="btn btn-sm btn-outline"
                            th:hx-get="@{/expenses/edit/{id}(id=${expense.id})}"
                            hx-target="#modals-here">
                        Edit
                    </button>
                    <button th:if="${expense.entityStatus == 'UNAUTHORIZED'}"
                            sec:authorize="hasRole('INPUTTER')"
                            class="btn btn-sm btn-danger"
                            th:hx-delete="@{/expenses/{id}(id=${expense.id})}"
                            hx-target="#expense-table-container"
                            hx-swap="outerHTML"
                            hx-confirm="Are you sure you want to delete this unauthorized record?">
                        Delete
                    </button>

                    <button th:if="${expense.entityStatus == 'UNAUTHORIZED' and expense.inputter != currentUser.email}"
                            sec:authorize="hasRole('ROLE_AUTHORIZER')"
                            class="btn btn-sm btn-success"
                            th:hx-post="@{/expenses/{id}/authorize(id=${expense.id})}"
                            hx-target="#expense-table-container"
                            hx-swap="outerHTML"
                            hx-confirm="Authorize this expense?">
                        Authorize
                    </button>
                </div>
            </td>
        </tr>
        <tr th:if="${expenses.isEmpty()}">
            <td colspan="5" style="text-align: center; padding: 2rem; color: #64748b;">
                No records found.
            </td>
        </tr>
        </tbody>
    </table>

    <div class="pagination-bar" th:if="${expenses.totalPages > 1}">
        <button th:if="${expenses.hasPrevious()}"
                class="btn btn-sm"
                th:hx-get="@{/expenses(page=${expenses.number - 1})}"
                hx-target="#expense-table-container"
                hx-swap="outerHTML">Previous</button>

        <span class="page-info" th:text="'Page ' + (${expenses.number} + 1) + ' of ' + ${expenses.totalPages}"></span>

        <button th:if="${expenses.hasNext()}"
                class="btn btn-sm"
                th:hx-get="@{/expenses(page=${expenses.number + 1})}"
                hx-target="#expense-table-container"
                hx-swap="outerHTML">Next</button>
    </div>
</div>

<div id="modals-here"></div>

<script th:inline="javascript">
    document.body.addEventListener('htmx:configRequest', (event) => {
        event.detail.headers['X-CSRF-TOKEN'] = /*[[${_csrf.token}]]*/ '';
    });
</script>
</body>
</html>